{% extends "base_public.html" %}
{% block title %}Resumix | Register{% endblock %}
{% block content %}
<section class="card auth-wrap">
  <aside class="auth-side">
    <h3>Why Register?</h3>
    <ul>
      <li>Secure personal analysis history.</li>
      <li>Upload and evaluate multiple resumes.</li>
      <li>Track fit trends for different job descriptions.</li>
      <li>Get actionable missing-skill insights.</li>
    </ul>
  </aside>

  <article>
    <h2>Create Account</h2>
    <p>Complete registration and continue to secure login.</p>
    <form id="registerForm">
      <div class="field">
        <label for="email">Email</label>
        <input id="email" type="email" required />
      </div>
      <div class="row">
        <div class="field">
          <label for="firstName">First Name</label>
          <input id="firstName" type="text" />
        </div>
        <div class="field">
          <label for="lastName">Last Name</label>
          <input id="lastName" type="text" />
        </div>
      </div>
      <div class="field">
        <label for="password">Password</label>
        <div class="password-wrap">
          <input id="password" type="password" minlength="8" required />
          <button class="toggle-btn" type="button" id="toggleRegisterPassword" aria-label="Show password">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
        <div class="strength" id="passwordStrength"></div>
      </div>
      <button class="btn" type="submit">Register</button>
      <div class="msg" id="registerMsg"></div>
    </form>
    <div class="inline-links">
      <a class="link" href="/login/">Already registered? Login</a>
    </div>
  </article>
</section>
{% endblock %}
{% block page_js %}
<script>
  (function () {
    const params = new URLSearchParams(window.location.search);
    if (params.get("fresh") === "1") {
      localStorage.removeItem("resumix_access");
      localStorage.removeItem("resumix_refresh");
      localStorage.removeItem("resumix_user");
      localStorage.removeItem("resumix_resume_id");
      localStorage.removeItem("resumix_uploaded_ready");
      localStorage.removeItem("resumix_analysis_completed");
    }

    const token = localStorage.getItem("resumix_access");
    if (token) {
      window.location.replace("/dashboard/");
      return;
    }

    const msgEl = document.getElementById("registerMsg");

    function setMessage(text, ok) {
      msgEl.textContent = text || "";
      msgEl.className = "msg " + (ok ? "ok" : "err");
      msgEl.style.display = text ? "block" : "none";
    }

    function getError(data) {
      if (!data) return "Unknown error";
      if (typeof data.detail === "string") return data.detail;
      if (Array.isArray(data.non_field_errors) && data.non_field_errors[0]) return data.non_field_errors[0];
      if (typeof data === "object") {
        const firstKey = Object.keys(data)[0];
        if (firstKey) {
          const val = data[firstKey];
          if (Array.isArray(val) && val[0]) return val[0];
          if (typeof val === "string") return val;
        }
      }
      return JSON.stringify(data);
    }

    document.getElementById("registerForm").addEventListener("submit", async function (event) {
      event.preventDefault();
      const payload = {
        email: document.getElementById("email").value,
        first_name: document.getElementById("firstName").value,
        last_name: document.getElementById("lastName").value,
        password: document.getElementById("password").value,
      };

      try {
        const res = await fetch("/api/auth/register/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(getError(data));
        }

        setMessage("Registration successful. Redirecting to login...", true);
        setTimeout(function () {
          window.location.href = "/login/?registered=1";
        }, 900);
      } catch (error) {
        setMessage(error.message, false);
      }
    });

    function updateStrength(value) {
      const strengthEl = document.getElementById("passwordStrength");
      if (!value) {
        strengthEl.textContent = "";
        strengthEl.className = "strength";
        return;
      }
      let score = 0;
      if (value.length >= 8) score += 1;
      if (value.length >= 12) score += 1;
      if (/[A-Z]/.test(value) && /[a-z]/.test(value)) score += 1;
      if (/\d/.test(value)) score += 1;
      if (/[^A-Za-z0-9]/.test(value)) score += 1;

      let label = "Weak";
      let cls = "weak";
      if (score >= 4) {
        label = "Strong";
        cls = "strong";
      } else if (score >= 2) {
        label = "Moderate";
        cls = "moderate";
      }
      strengthEl.textContent = "Password strength: " + label;
      strengthEl.className = "strength " + cls;
    }

    const passwordInput = document.getElementById("password");
    passwordInput.addEventListener("input", function (event) {
      updateStrength(event.target.value || "");
    });

    const toggleBtn = document.getElementById("toggleRegisterPassword");
    toggleBtn.addEventListener("click", function () {
      const isHidden = passwordInput.type === "password";
      passwordInput.type = isHidden ? "text" : "password";
      toggleBtn.classList.toggle("active", isHidden);
      toggleBtn.setAttribute("aria-label", isHidden ? "Hide password" : "Show password");
    });
  })();
</script>
{% endblock %}
